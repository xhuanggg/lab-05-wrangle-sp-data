closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.2) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, binwidth_m = 0.5) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
# Source pattern: https://stackoverflow.com/a/36149654
# Posted by inscaven
# Retrieved 2026-02-08, License - CC BY-SA 3.0
library(usmap) #import the package
library(tidyverse)
library(usmap)
library(ggplot2)
library(sf)
library(grid)
dn <- dennys
lq <- laquinta
# 1) Closest La Quinta distance for each Denny's (all states)
dn_lq_full <- full_join(
dn, lq,
by = "state",
suffix = c(".d", ".l")
) %>%
filter(!is.na(latitude.d) & !is.na(latitude.l)) %>%
filter(!state %in% c("AK", "HI"))
dn_lq_full_mindist <- dn_lq_full %>%
group_by(address.d) %>%
mutate(distance = haversine(longitude.d, latitude.d, longitude.l, latitude.l)) %>%
summarize(
closest = min(distance, na.rm = TRUE),
state   = first(state),
.groups = "drop"
)
# 2) Per-state binned distributions (these become the embedded mini bar charts)
binwidth_m <- 25
# Cap extreme tail so small charts remain legible
x_cap <- as.numeric(quantile(dn_lq_full_mindist$closest, 0.99, na.rm = TRUE))
x_max <- ceiling(x_cap / binwidth_m) * binwidth_m
state_bins <- dn_lq_full_mindist %>%
mutate(
closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.2) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, binwidth_m = 0.2) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
# Source pattern: https://stackoverflow.com/a/36149654
# Posted by inscaven
# Retrieved 2026-02-08, License - CC BY-SA 3.0
library(usmap) #import the package
library(tidyverse)
library(usmap)
library(ggplot2)
library(sf)
library(grid)
dn <- dennys
lq <- laquinta
# 1) Closest La Quinta distance for each Denny's (all states)
dn_lq_full <- full_join(
dn, lq,
by = "state",
suffix = c(".d", ".l")
) %>%
filter(!is.na(latitude.d) & !is.na(latitude.l)) %>%
filter(!state %in% c("AK", "HI"))
dn_lq_full_mindist <- dn_lq_full %>%
group_by(address.d) %>%
mutate(distance = haversine(longitude.d, latitude.d, longitude.l, latitude.l)) %>%
summarize(
closest = min(distance, na.rm = TRUE),
state   = first(state),
.groups = "drop"
)
# 2) Per-state binned distributions (these become the embedded mini bar charts)
binwidth_m <- 25
# Cap extreme tail so small charts remain legible
x_cap <- as.numeric(quantile(dn_lq_full_mindist$closest, 0.99, na.rm = TRUE))
x_max <- ceiling(x_cap / binwidth_m) * binwidth_m
state_bins <- dn_lq_full_mindist %>%
mutate(
closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.2) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, width = 0.2) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
# Source pattern: https://stackoverflow.com/a/36149654
# Posted by inscaven
# Retrieved 2026-02-08, License - CC BY-SA 3.0
library(usmap) #import the package
library(tidyverse)
library(usmap)
library(ggplot2)
library(sf)
library(grid)
dn <- dennys
lq <- laquinta
# 1) Closest La Quinta distance for each Denny's (all states)
dn_lq_full <- full_join(
dn, lq,
by = "state",
suffix = c(".d", ".l")
) %>%
filter(!is.na(latitude.d) & !is.na(latitude.l)) %>%
filter(!state %in% c("AK", "HI"))
dn_lq_full_mindist <- dn_lq_full %>%
group_by(address.d) %>%
mutate(distance = haversine(longitude.d, latitude.d, longitude.l, latitude.l)) %>%
summarize(
closest = min(distance, na.rm = TRUE),
state   = first(state),
.groups = "drop"
)
# 2) Per-state binned distributions (these become the embedded mini bar charts)
binwidth_m <- 25
# Cap extreme tail so small charts remain legible
x_cap <- as.numeric(quantile(dn_lq_full_mindist$closest, 0.99, na.rm = TRUE))
x_max <- ceiling(x_cap / binwidth_m) * binwidth_m
state_bins <- dn_lq_full_mindist %>%
mutate(
closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.7) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, width = 0.2) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
# Source pattern: https://stackoverflow.com/a/36149654
# Posted by inscaven
# Retrieved 2026-02-08, License - CC BY-SA 3.0
library(usmap) #import the package
library(tidyverse)
library(usmap)
library(ggplot2)
library(sf)
library(grid)
dn <- dennys
lq <- laquinta
# 1) Closest La Quinta distance for each Denny's (all states)
dn_lq_full <- full_join(
dn, lq,
by = "state",
suffix = c(".d", ".l")
) %>%
filter(!is.na(latitude.d) & !is.na(latitude.l)) %>%
filter(!state %in% c("AK", "HI"))
dn_lq_full_mindist <- dn_lq_full %>%
group_by(address.d) %>%
mutate(distance = haversine(longitude.d, latitude.d, longitude.l, latitude.l)) %>%
summarize(
closest = min(distance, na.rm = TRUE),
state   = first(state),
.groups = "drop"
)
# 2) Per-state binned distributions (these become the embedded mini bar charts)
binwidth_m <- 25
# Cap extreme tail so small charts remain legible
x_cap <- as.numeric(quantile(dn_lq_full_mindist$closest, 0.99, na.rm = TRUE))
x_max <- ceiling(x_cap / binwidth_m) * binwidth_m
state_bins <- dn_lq_full_mindist %>%
mutate(
closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.2) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, width = 0.7) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
# Source pattern: https://stackoverflow.com/a/36149654
# Posted by inscaven
# Retrieved 2026-02-08, License - CC BY-SA 3.0
library(usmap) #import the package
library(tidyverse)
library(usmap)
library(ggplot2)
library(sf)
library(grid)
dn <- dennys
lq <- laquinta
# 1) Closest La Quinta distance for each Denny's (all states)
dn_lq_full <- full_join(
dn, lq,
by = "state",
suffix = c(".d", ".l")
) %>%
filter(!is.na(latitude.d) & !is.na(latitude.l)) %>%
filter(!state %in% c("AK", "HI"))
dn_lq_full_mindist <- dn_lq_full %>%
group_by(address.d) %>%
mutate(distance = haversine(longitude.d, latitude.d, longitude.l, latitude.l)) %>%
summarize(
closest = min(distance, na.rm = TRUE),
state   = first(state),
.groups = "drop"
)
# 2) Per-state binned distributions (these become the embedded mini bar charts)
binwidth_m <- 25
# Cap extreme tail so small charts remain legible
x_cap <- as.numeric(quantile(dn_lq_full_mindist$closest, 0.99, na.rm = TRUE))
x_max <- ceiling(x_cap / binwidth_m) * binwidth_m
state_bins <- dn_lq_full_mindist %>%
mutate(
closest_cap = pmin(closest, x_max),
bin_left    = floor(closest_cap / binwidth_m) * binwidth_m,
bin_mid     = bin_left + binwidth_m / 2
) %>%
count(state, bin_mid, name = "n")
y_max <- max(state_bins$n, na.rm = TRUE)
# 3) US map as sf + centroids
states_sf <- usmap::us_map(regions = "states")
state_centroids <- states_sf %>%
st_centroid() %>%
mutate(
x = st_coordinates(.)[, 1],
y = st_coordinates(.)[, 2]
) %>%
st_drop_geometry() %>%
transmute(state = abbr, x = x, y = y)
# Bounding box for scaling embedded plot sizes
bb <- st_bbox(states_sf)
x_range <- as.numeric(bb["xmax"] - bb["xmin"])
y_range <- as.numeric(bb["ymax"] - bb["ymin"])
# Size of embedded mini-plots in map coordinate units
dx <- x_range * 0.04
dy <- y_range * 0.04
# 4) Base map
base_map <- ggplot() +
geom_sf(data = states_sf, fill = "white", color = "gray60", linewidth = 0.2) +
coord_sf(clip = "off") +
theme_void()
# 5) Build one mini-plot per state and place it at the state's centroid
annotation_list <- purrr::pmap(
list(state_centroids$state, state_centroids$x, state_centroids$y),
function(st, cx, cy) {
st_dat <- state_bins %>% filter(state == st)
if (nrow(st_dat) < 2) return(NULL)
mini <- ggplot(st_dat, aes(x = bin_mid, y = n)) +
geom_col(color = "blue", fill = "blue", linewidth = 0.2, width = 1) +
scale_x_continuous(limits = c(0, x_max), expand = c(0, 0)) +
scale_y_continuous(limits = c(0, y_max), expand = c(0, 0)) +
theme_void() +
theme(
plot.background = element_rect(fill = scales::alpha("white", 0.3), color = NA),
plot.margin = margin(1, 1, 1, 1)
)
annotation_custom(
grob = ggplotGrob(mini),
xmin = cx - dx, xmax = cx + dx,
ymin = cy - dy, ymax = cy + dy
)
}
)
annotation_list <- purrr::compact(annotation_list)
result_plot <- Reduce(`+`, annotation_list, base_map)
ggsave(
result_plot,
filename = "img/histogram-map.png",
width = 10, height = 6, units = "in", dpi = 300
)
